<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commute Dashboard - Cedar Ren</title>
    <style>
        :root {
            --bg: #0f0f1a;
            --card-bg: #1a1a2e;
            --accent: #00d4ff;
            --vta: #00a2ff;
            --caltrain: #e31837;
            --text: #f0f0f0;
            --muted: #888;
            --success: #00ff88;
            --warning: #ffcc00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .route-summary {
            color: var(--muted);
            font-size: 0.95rem;
        }

        .commute-path {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .path-node {
            text-align: center;
        }

        .path-node .icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .path-node .label {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .path-arrow {
            color: var(--muted);
            font-size: 1.2rem;
        }

        .transit-section {
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: var(--card-bg);
            border-radius: 10px;
        }

        .section-header.vta {
            border-left: 4px solid var(--vta);
        }

        .section-header.caltrain {
            border-left: 4px solid var(--caltrain);
        }

        .section-header .agency-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .section-header.vta .agency-badge {
            background: var(--vta);
            color: white;
        }

        .section-header.caltrain .agency-badge {
            background: var(--caltrain);
            color: white;
        }

        .section-header .stop-name {
            flex: 1;
            font-size: 1rem;
        }

        .arrivals-list {
            display: grid;
            gap: 10px;
        }

        .arrival-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s;
        }

        .arrival-card:hover {
            transform: translateX(5px);
        }

        .line-badge {
            min-width: 50px;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            font-size: 0.9rem;
        }

        .vta .line-badge {
            background: var(--vta);
            color: white;
        }

        .caltrain .line-badge {
            background: var(--caltrain);
            color: white;
        }

        .arrival-info {
            flex: 1;
        }

        .destination {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .stop-detail {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .arrival-time {
            text-align: right;
            min-width: 70px;
        }

        .time-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .time-value.now {
            color: var(--success);
            animation: pulse 1s infinite;
        }

        .time-value.soon {
            color: var(--warning);
        }

        .time-label {
            font-size: 0.75rem;
            color: var(--muted);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: var(--muted);
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--card-bg);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #ff4444;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.85rem;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .refresh-btn {
            background: var(--accent);
            color: var(--bg);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .refresh-btn:hover {
            opacity: 0.9;
        }

        .total-time {
            background: linear-gradient(135deg, var(--vta), var(--caltrain));
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
        }

        .total-time .label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .total-time .value {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .config-section {
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .config-section summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--accent);
        }

        .config-section .config-content {
            margin-top: 15px;
            display: grid;
            gap: 10px;
        }

        .config-section input {
            background: var(--bg);
            border: 1px solid #333;
            color: var(--text);
            padding: 10px;
            border-radius: 6px;
            width: 100%;
        }

        .config-section label {
            font-size: 0.85rem;
            color: var(--muted);
            display: block;
            margin-bottom: 5px;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            color: var(--muted);
            font-size: 0.8rem;
        }

        footer a {
            color: var(--accent);
            text-decoration: none;
        }

        .no-data {
            color: var(--muted);
            font-style: italic;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöå Commute Dashboard</h1>
            <div class="route-summary">490 E Middlefield ‚Üí MTV Caltrain ‚Üí 22nd St</div>

            <div class="commute-path">
                <div class="path-node">
                    <div class="icon">üìç</div>
                    <div class="label">Middlefield</div>
                </div>
                <div class="path-arrow">‚Üí</div>
                <div class="path-node">
                    <div class="icon" style="color: var(--vta);">üöå</div>
                    <div class="label">VTA</div>
                </div>
                <div class="path-arrow">‚Üí</div>
                <div class="path-node">
                    <div class="icon">üöâ</div>
                    <div class="label">MTV</div>
                </div>
                <div class="path-arrow">‚Üí</div>
                <div class="path-node">
                    <div class="icon" style="color: var(--caltrain);">üöÜ</div>
                    <div class="label">Caltrain</div>
                </div>
                <div class="path-arrow">‚Üí</div>
                <div class="path-node">
                    <div class="icon">üéØ</div>
                    <div class="label">22nd St</div>
                </div>
            </div>
        </header>

        <details class="config-section">
            <summary>‚öôÔ∏è Configuration</summary>
            <div class="config-content">
                <div>
                    <label>Proxy URL (recommended - keeps API key secret)</label>
                    <input type="text" id="proxyUrl" placeholder="https://your-worker.workers.dev">
                </div>
                <div>
                    <label>OR API Token directly (exposes key in browser)</label>
                    <input type="password" id="apiToken" placeholder="Only if not using proxy">
                </div>
                <hr style="border-color: #333; margin: 10px 0;">
                <div>
                    <label>VTA Stop ID (near 490 E Middlefield) - 64818 = Middlefield LRT</label>
                    <input type="text" id="vtaStopId" value="64818" placeholder="e.g., 64818">
                </div>
                <div>
                    <label>Caltrain MTV Stop ID</label>
                    <input type="text" id="caltrainMtvStopId" value="70211" placeholder="e.g., 70211">
                </div>
                <button class="refresh-btn" onclick="saveConfigAndRefresh()" style="margin-top: 10px;">Save & Refresh</button>
            </div>
        </details>

        <div id="totalTimeSection" class="total-time" style="display: none;">
            <div class="label">Estimated Total Travel Time</div>
            <div class="value" id="totalTime">--</div>
        </div>

        <div class="status-bar">
            <div class="live-indicator">
                <span class="live-dot"></span>
                <span>Live Data</span>
            </div>
            <span id="lastUpdate">--</span>
            <button class="refresh-btn" onclick="refreshAll()">Refresh</button>
        </div>

        <!-- VTA Section -->
        <div class="transit-section">
            <div class="section-header vta">
                <span class="agency-badge">VTA</span>
                <span class="stop-name">Middlefield Rd ‚Üí Mountain View Transit Center</span>
            </div>
            <div id="vtaArrivals" class="arrivals-list">
                <div class="loading">
                    <div class="spinner"></div>
                    Enter API token to load arrivals
                </div>
            </div>
        </div>

        <!-- Caltrain Section -->
        <div class="transit-section">
            <div class="section-header caltrain">
                <span class="agency-badge">Caltrain</span>
                <span class="stop-name">Mountain View ‚Üí 22nd Street (Northbound)</span>
            </div>
            <div id="caltrainArrivals" class="arrivals-list">
                <div class="loading">
                    <div class="spinner"></div>
                    Enter API token to load arrivals
                </div>
            </div>
        </div>

        <footer>
            <p>Data from <a href="https://511.org" target="_blank">511 SF Bay</a></p>
            <p>Built for <a href="/">cedar.ren</a></p>
        </footer>
    </div>

    <script>
        // Configuration
        // VTA Stop IDs near 490 E Middlefield Rd:
        //   - 64818: Middlefield Light Rail (Orange Line to MTV)
        //   - Route 40 stops on Middlefield go to MTV Transit Center
        // Caltrain: 70212 = MTV Northbound, 70021 = 22nd St Northbound
        const CONFIG = {
            // Use proxy to hide API key (deploy workers/transit-proxy.js to Cloudflare)
            proxyUrl: 'https://round-heart-428a.infraredhammerhead.workers.dev',
            apiToken: '',  // Fallback: direct API key (exposes key in browser)
            vtaStopId: '64818',         // Middlefield Light Rail Station (toward MTV)
            caltrainMtvStopId: '70211', // Mountain View Caltrain (Northbound to SF)
            caltrain22ndStopId: '70021' // 22nd St (for reference)
        };

        // Load saved config
        function loadConfig() {
            const saved = localStorage.getItem('commuteConfig');
            if (saved) {
                Object.assign(CONFIG, JSON.parse(saved));
            }

            // Populate form
            document.getElementById('proxyUrl').value = CONFIG.proxyUrl;
            document.getElementById('apiToken').value = CONFIG.apiToken;
            document.getElementById('vtaStopId').value = CONFIG.vtaStopId;
            document.getElementById('caltrainMtvStopId').value = CONFIG.caltrainMtvStopId;
        }

        function saveConfigAndRefresh() {
            CONFIG.proxyUrl = document.getElementById('proxyUrl').value.trim();
            CONFIG.apiToken = document.getElementById('apiToken').value.trim();
            CONFIG.vtaStopId = document.getElementById('vtaStopId').value.trim();
            CONFIG.caltrainMtvStopId = document.getElementById('caltrainMtvStopId').value.trim();

            localStorage.setItem('commuteConfig', JSON.stringify(CONFIG));

            refreshAll();
        }

        async function fetchArrivals(agency, stopCode) {
            let url;

            if (CONFIG.proxyUrl) {
                // Use secure proxy (recommended)
                url = `${CONFIG.proxyUrl}?agency=${agency}&stopCode=${stopCode}`;
            } else if (CONFIG.apiToken) {
                // Direct API call (exposes key in browser network tab)
                url = `https://api.511.org/transit/StopMonitoring?api_key=${CONFIG.apiToken}&agency=${agency}&stopCode=${stopCode}&format=json`;
            } else {
                throw new Error('Configure proxy URL or API token');
            }

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            const text = await response.text();
            // Remove BOM if present
            const cleanText = text.replace(/^\uFEFF/, '');
            return JSON.parse(cleanText);
        }

        function formatMinutes(isoTime) {
            if (!isoTime) return { value: '?', class: '' };

            try {
                const expected = new Date(isoTime);
                const now = new Date();
                const diffMs = expected - now;
                const diffMins = Math.round(diffMs / 60000);

                if (diffMins < 1) return { value: 'Now', class: 'now' };
                if (diffMins < 5) return { value: `${diffMins}`, class: 'soon' };
                if (diffMins < 60) return { value: `${diffMins}`, class: '' };

                return {
                    value: expected.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    class: ''
                };
            } catch {
                return { value: '?', class: '' };
            }
        }

        function renderArrivals(data, containerId, agencyClass) {
            const container = document.getElementById(containerId);

            try {
                const visits = data?.ServiceDelivery?.StopMonitoringDelivery?.MonitoredStopVisit || [];

                if (visits.length === 0) {
                    container.innerHTML = '<div class="no-data">No arrivals found</div>';
                    return [];
                }

                const arrivals = visits.slice(0, 5).map(visit => {
                    const journey = visit.MonitoredVehicleJourney || {};
                    const call = journey.MonitoredCall || {};

                    const line = journey.PublishedLineName || journey.LineRef || '?';
                    const destination = journey.DestinationName || 'Unknown';
                    const expectedTime = call.ExpectedArrivalTime || call.ExpectedDepartureTime || '';
                    const stopName = call.StopPointName || '';

                    const timeInfo = formatMinutes(expectedTime);

                    return {
                        line,
                        destination,
                        stopName,
                        expectedTime,
                        timeInfo
                    };
                });

                container.innerHTML = arrivals.map(arr => `
                    <div class="arrival-card ${agencyClass}">
                        <div class="line-badge">${escapeHtml(arr.line)}</div>
                        <div class="arrival-info">
                            <div class="destination">${escapeHtml(arr.destination)}</div>
                            <div class="stop-detail">${escapeHtml(arr.stopName)}</div>
                        </div>
                        <div class="arrival-time">
                            <div class="time-value ${arr.timeInfo.class}">${arr.timeInfo.value}</div>
                            <div class="time-label">${arr.timeInfo.value === 'Now' ? '' : 'min'}</div>
                        </div>
                    </div>
                `).join('');

                return arrivals;

            } catch (error) {
                container.innerHTML = `<div class="error">Error: ${escapeHtml(error.message)}</div>`;
                return [];
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function refreshAll() {
            if (!CONFIG.proxyUrl && !CONFIG.apiToken) {
                document.getElementById('vtaArrivals').innerHTML = '<div class="no-data">Configure proxy URL or API token</div>';
                document.getElementById('caltrainArrivals').innerHTML = '<div class="no-data">Configure proxy URL or API token</div>';
                return;
            }

            // Show loading
            document.getElementById('vtaArrivals').innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            document.getElementById('caltrainArrivals').innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            try {
                // Fetch both in parallel
                const [vtaData, caltrainData] = await Promise.all([
                    fetchArrivals('VT', CONFIG.vtaStopId).catch(e => ({ error: e.message })),
                    fetchArrivals('CT', CONFIG.caltrainMtvStopId).catch(e => ({ error: e.message }))
                ]);

                // Render VTA
                if (vtaData.error) {
                    document.getElementById('vtaArrivals').innerHTML = `<div class="error">${escapeHtml(vtaData.error)}</div>`;
                } else {
                    renderArrivals(vtaData, 'vtaArrivals', 'vta');
                }

                // Render Caltrain
                if (caltrainData.error) {
                    document.getElementById('caltrainArrivals').innerHTML = `<div class="error">${escapeHtml(caltrainData.error)}</div>`;
                } else {
                    renderArrivals(caltrainData, 'caltrainArrivals', 'caltrain');
                }

                // Update timestamp
                document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error('Refresh error:', error);
            }
        }

        // Initialize
        window.onload = function() {
            loadConfig();

            if (CONFIG.proxyUrl || CONFIG.apiToken) {
                refreshAll();
            }

            // Auto-refresh every 60 seconds
            setInterval(refreshAll, 60000);
        };
    </script>
</body>
</html>
