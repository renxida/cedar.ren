<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commute</title>
    <style>
        body {
            background: #000;
            color: #0f0;
            font-family: monospace;
            font-size: 14px;
            padding: 20px;
            white-space: pre;
        }
    </style>
</head>
<body><script>
const PROXY = 'https://round-heart-428a.infraredhammerhead.workers.dev';
const STOPS = {
    vta: { agency: 'SC', stop: '64818', name: 'Middlefield LRT' },
    caltrain: { agency: 'CT', stop: '70211', name: 'Mountain View NB' }
};

async function fetch511(agency, stop) {
    const r = await fetch(`${PROXY}?agency=${agency}&stopCode=${stop}`);
    const t = await r.text();
    return JSON.parse(t.replace(/^\uFEFF/, ''));
}

function parseArrivals(data) {
    const visits = data?.ServiceDelivery?.StopMonitoringDelivery?.MonitoredStopVisit || [];
    return visits.slice(0, 5).map(v => {
        const j = v.MonitoredVehicleJourney || {};
        const c = j.MonitoredCall || {};
        return {
            line: j.PublishedLineName || j.LineRef || '?',
            dest: j.DestinationName || '?',
            time: c.ExpectedArrivalTime || c.ExpectedDepartureTime || ''
        };
    });
}

function formatMins(iso) {
    if (!iso) return '?';
    const diff = (new Date(iso) - new Date()) / 60000;
    if (diff < 1) return 'NOW';
    if (diff < 60) return Math.round(diff) + 'm';
    return new Date(iso).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
}

function pad(s, n) { return (s + '').slice(0, n).padEnd(n); }

async function refresh() {
    let out = '';
    out += '='.repeat(50) + '\n';
    out += 'COMMUTE DASHBOARD\n';
    out += 'Updated: ' + new Date().toLocaleTimeString() + '\n';
    out += '='.repeat(50) + '\n';

    for (const [key, cfg] of Object.entries(STOPS)) {
        out += '\n=== ' + cfg.name + ' ===\n';
        try {
            const data = await fetch511(cfg.agency, cfg.stop);
            const arrivals = parseArrivals(data);
            if (arrivals.length === 0) {
                out += '  No arrivals\n';
            } else {
                for (const a of arrivals) {
                    out += '  ' + pad(a.line, 12) + ' ' + pad(a.dest, 25) + ' ' + formatMins(a.time).padStart(6) + '\n';
                }
            }
        } catch (e) {
            out += '  Error: ' + e.message + '\n';
        }
    }

    out += '\n' + '='.repeat(50);
    document.body.textContent = out;
}

refresh();
setInterval(refresh, 60000);
</script></body>
</html>
